---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment
spec:
  replicas: 1
  template:
    spec:
      volumes:
        - name: truenas-media
          persistentVolumeClaim:
            claimName: truenas-media
      containers:
        - name: immich
          image: ghcr.io/immich-app/immich-server:v1.110.0
          command: [/usr/src/app/start.sh]
          args: [immich]
          env:
            - name: TZ
              value: America/Denver
            - name: DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: immich-common-postgres-superuser
                  key: user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: immich-common-postgres-superuser
                  key: password
            - name: DB_HOSTNAME
              valueFrom:
                secretKeyRef:
                  name: immich-common-postgres-superuser
                  key: host
            - name: DB_DATABASE_NAME
              valueFrom:
                secretKeyRef:
                  name: immich-common-postgres-app
                  key: dbname
            - name: REDIS_HOSTNAME
              value: immich-common-cache-service
          resources:
            limits:
              memory: 1G
          volumeMounts:
            - name: truenas-media
              mountPath: /media
            - name: truenas-media
              subPath: Uploads
              mountPath: /usr/src/app/upload
          ports:
            - name: http
              containerPort: 3001

---
apiVersion: v1
kind: Service
metadata:
  name: service
spec:
  ports:
    - name: http
      port: 80
      targetPort: http
