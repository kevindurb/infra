---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment
spec:
  replicas: 1
  template:
    spec:
      volumes:
        - name: data-volume
          persistentVolumeClaim:
            claimName: data-volume
      containers:
        - name: freshrss
          image: docker.io/freshrss/freshrss
          env: &env
            - name: TZ
              value: America/Denver
            - name: DB_TYPE
              value: pgsql
            - name: DB_BASE
              valueFrom:
                secretKeyRef:
                  name: freshrss-postgres-app
                  key: dbname
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: freshrss-postgres-app
                  key: user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: freshrss-postgres-app
                  key: password
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: freshrss-postgres-app
                  key: host
            - name: FRESHRSS_INSTALL
              value: >-
                --db-base $(DB_BASE)
                --db-host $(DB_HOST)
                --db-password $(DB_PASSWORD)
                --db-type pgsql
                --db-user $(DB_USER)
                --default_user kevindurb
                --language en
            - name: FRESHRSS_USER
              value: >-
                --language en
                --password password
                --user kevindurb
            - name: CRON_MIN
              value: 0,15,30,45
          volumeMounts: &volumeMounts
            - name: data-volume
              mountPath: /var/www/FreshRSS/data
          resources:
            limits:
              memory: 1G
          ports:
            - name: http
              containerPort: 80
        - name: freshrss-cron
          image: docker.io/freshrss/freshrss
          env: *env
          volumeMounts: *volumeMounts
          args: [cron, -f]

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-volume
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  resources:
    requests:
      storage: 10Gi

---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres
spec:
  instances: 3
  storage:
    storageClass: local-storage
    size: 5Gi
  backup:
    retentionPolicy: 30d
    barmanObjectStore:
      destinationPath: s3://volume-backups/freshrss-postgres
      endpointURL: http://minio-api-service
      s3Credentials:
        accessKeyId:
          name: freshrss-restic-config
          key: AWS_ACCESS_KEY_ID
        secretAccessKey:
          name: freshrss-restic-config
          key: AWS_SECRET_ACCESS_KEY

---
apiVersion: v1
kind: Service
metadata:
  name: service
spec:
  ports:
    - name: http
      port: 80
      targetPort: http
