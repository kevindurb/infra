---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment
spec:
  replicas: 1
  template:
    spec:
      containers:
        - name: wallabag
          image: wallabag/wallabag
          env:
            - name: SYMFONY__ENV__DATABASE_DRIVER
              value: pdo_pgsql
            - name: SYMFONY__ENV__DATABASE_HOST
              value: wallabag-postgres
            - name: SYMFONY__ENV__DATABASE_PORT
              value: '5432'
            - name: SYMFONY__ENV__DATABASE_NAME
              value: wallabag
            - name: SYMFONY__ENV__DOMAIN_NAME
              value: https://wallabag.durbin.casa
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: wallabag.wallabag-postgres.credentials.postgresql.acid.zalan.do
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: wallabag.wallabag-postgres.credentials.postgresql.acid.zalan.do
                  key: password
            - name: SYMFONY__ENV__DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: wallabag.wallabag-postgres.credentials.postgresql.acid.zalan.do
                  key: username
            - name: SYMFONY__ENV__DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: wallabag.wallabag-postgres.credentials.postgresql.acid.zalan.do
                  key: password
          ports:
            - name: web
              containerPort: 80

---
apiVersion: 'acid.zalan.do/v1'
kind: postgresql
metadata:
  name: postgres
spec:
  teamId: wallabag
  volume:
    size: 2Gi
    storageClass: nfs-csi
  numberOfInstances: 2
  users:
    wallabag:
      - superuser
      - createdb
  postgresql:
    version: '15'

---
apiVersion: v1
kind: Service
metadata:
  name: service
spec:
  ports:
    - name: web
      port: 80
      targetPort: web
