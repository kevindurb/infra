---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment
spec:
  strategy:
    type: Recreate
  template:
    spec:
      containers:
        - image: lscr.io/linuxserver/smokeping
          name: smokeping
          ports:
            - name: web
              containerPort: 80
          volumeMounts:
            - name: data
              mountPath: /data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: data-volume

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-volume
  annotations:
    volumeType: local
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  resources:
    requests:
      storage: 1Gi

---
apiVersion: v1
kind: Service
metadata:
  name: service
spec:
  type: LoadBalancer
  ports:
    - name: web
      port: 80
      targetPort: web

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress
spec:
  ingressClassName: tailscale
  defaultBackend:
    service:
      name: service
      port:
        name: web
  tls:
    - hosts:
        - smokeping

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: restic-config
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: gitlab-secret-store
  target:
    name: smokeping-restic-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        RESTIC_REPOSITORY: 's3:https://{{.R2_ACCOUNT_ID}}.r2.cloudflarestorage.com/k8s-volume-backups'
        RESTIC_PASSWORD: '{{.RESTIC_PASSWORD}}'
        AWS_ACCESS_KEY_ID: '{{.AWS_ACCESS_KEY_ID}}'
        AWS_SECRET_ACCESS_KEY: '{{.AWS_SECRET_ACCESS_KEY}}'
  data:
    - secretKey: R2_ACCOUNT_ID
      remoteRef:
        key: R2_ACCOUNT_ID
    - secretKey: RESTIC_PASSWORD
      remoteRef:
        key: RESTIC_PASSWORD
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: R2_ACCESS_KEY_ID
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: R2_SECRET_ACCESS_KEY

---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: data-backup
spec:
  sourcePVC: smokeping-data-volume
  trigger:
    schedule: '0 * * * *'
  restic:
    pruneIntervalDays: 14
    repository: smokeping-restic-config
    retain:
      hourly: 6
      daily: 5
      weekly: 4
      monthly: 2
      yearly: 1
    copyMethod: Direct
