# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

# TODO: can i have global envs from vars?
# TODO: can i refactor out the minijinja command?

vars:
  TEMPLATES_DIR: '{{.ROOT_DIR}}/.taskfiles/templates/resources'
  MINIJINJA_ARGS: >-
    --env
    --trim-blocks
    --lstrip-blocks
    --autoescape=none

tasks:
  app:
    aliases: [mk]
    requires:
      vars: [appname, image]
    cmds:
      - task: kustomization
      - task: deployment
      - task: service
      - task: internal-ingress
      - task: gatus

  external-app:
    aliases: [mk-ext]
    requires:
      vars: [appname, ip]
    cmds:
      - task: kustomization
      - task: external-endpoint
      - task: gatus

  kustomization:
    aliases: [ks]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}
    env:
      APP: '{{.appname}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/kustomization.yml.j2
        > kustomization.yml

  deployment:
    aliases: [deploy]
    requires:
      vars: [appname, image, port]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      COMP: '{{or .component "web"}}'
      IMG: '{{.image}}'
      PORT: '{{.port}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/deployment.yml.j2
        > {{or .component "web"}}-deployment.yml

  service:
    aliases: [svc]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      COMP: '{{or .component "web"}}'
      PORT: '{{.port}}'
      PROTO: '{{or .proto "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/service.yml.j2
        > {{or .component "web"}}-service.yml

  external-endpoint:
    aliases: [ext]
    requires:
      vars: [appname, ip]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      SUBDOMAIN: '{{or .subdomain .appname}}'
      IP: '{{.ip}}'
      COMP: '{{or .component "web"}}'
      PORT: '{{or .port "80"}}'
      PROTO: '{{or .proto "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/external-endpoint.yml.j2
        > external-endpoint.yml

  internal-ingress:
    aliases: [int-ing]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      SUBDOMAIN: '{{or .subdomain .appname}}'
      PORT: '{{or .port "80"}}'
      PROTO: '{{or .proto "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/internal-ingress.yml.j2
        > internal-ingress.yml

  external-ingress:
    aliases: [ext-ing]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      SUBDOMAIN: '{{or .subdomain .appname}}'
      PORT: '{{or .port "80"}}'
      PROTO: '{{or .proto "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/external-ingress.yml.j2
        > external-ingress.yml

  persistent-volume-claim:
    aliases: [pvc]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      SIZE: '{{or .size "1G"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/pvc.yml.j2
        > pvc.yml

  postgres:
    aliases: [pg, db]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/postgres.yml.j2
        > postgres.yml

  valkey:
    aliases: [redis]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/valkey.yml.j2
        > valkey.yml

  bitwarden-secret:
    aliases: [secret]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/bitwarden-secret.yml.j2
        > bitwarden-secret.yml

  gatus-config:
    aliases: [gatus]
    requires:
      vars: [appname]
    dir: ./k8s/{{ .appname }}/resources
    env:
      APP: '{{.appname}}'
      PROTO: '{{or .proto "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/gatus-config.yml.j2
        > gatus-config.yml
