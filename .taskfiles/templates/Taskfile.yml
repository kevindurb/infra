# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

tasks:
  mk:
    requires:
      vars: [appname, image]
    cmds:
      - task: ks
      - task: deploy
      - task: svc
      - task: ts-ing
        vars:
          subdomain: '{{ or .subdomain .appname }}'

  ks:
    requires:
      vars: [appname]
    sources: ['resources/*']
    dir: ./services/{{ .appname }}
    cmds:
      - |
        cat << EOF > kustomization.yml
        ---
        apiVersion: kustomize.config.k8s.io/v1beta1
        kind: Kustomization

        namePrefix: {{ .appname }}-

        resources:
        {{ range $item := .sources }}
          - ./resources/$item
        {{ end }}

        commonLabels:
          app.kubernetes.io/name: {{ .appname }}
        EOF

  deploy:
    requires:
      vars: [appname, image]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > deployment.yml
        ---
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: deployment
          labels: &labels
            app.kubernetes.io/component: {{ or .component "web" }}
        spec:
          replicas: 1
          strategy:
            type: Recreate
          selector:
            matchLabels: *labels
          template:
            metadata:
              labels: *labels
            spec:
              # volumes:
              #   - name: volume
              #     persistentVolumeClaim:
              #       claimName: volume
              containers:
                - name: {{ or .name .appname }}
                  image: {{ .image }}
                  # volumeMounts:
                  #   - name: volume
                  #     mountPath: /var/www/app/data
                  ports:
                    - name: {{ or .portname "web" }}
                      containerPort: {{ or .port 8080 }}
        EOF

  svc:
    requires:
      vars: [appname]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > service.yml
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: service
        spec:
          selector:
            app.kubernetes.io/component: {{ or .component "web" }}
          ports:
            - name: {{ or .portname "web" }}
              port: 80
              targetPort: {{ or .portname "web" }}
        EOF

  lan-ing:
    requires:
      vars: [appname, subdomain]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > ingress.yml
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: lan-ingress
          annotations:
            external-dns.alpha.kubernetes.io/hostname: &host {{ .subdomain }}.durbin.casa
            cert-manager.io/cluster-issuer: cloudflare-issuer
        spec:
          ingressClassName: nginx
          tls:
            - hosts: [*host]
              secretName: durbin-casa-wildcard-cert
          rules:
            - host: *host
              http:
                paths:
                  - pathType: Prefix
                    path: '/'
                    backend:
                      service:
                        name: service
                        port:
                          name: {{ or .portname "web" }}
        EOF

  ts-ing:
    requires:
      vars: [appname, subdomain]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > ingress.yml
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: tailscale-ingress
        spec:
          ingressClassName: tailscale
          defaultBackend:
            service:
              name: service
              port:
                name: {{ or .portname "web" }}
          tls:
            - hosts:
                - {{ .subdomain }}
        EOF

  pvc:
    requires:
      vars: [appname]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > pvc.yml
        ---
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: volume
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: local-storage
          resources:
            requests:
              storage: {{ or .size "1G" }}
        ---
        apiVersion: external-secrets.io/v1beta1
        kind: ExternalSecret
        metadata:
          name: volume-repository
        spec:
          refreshInterval: 1h
          secretStoreRef:
            kind: ClusterSecretStore
            name: gitlab-secret-store
          target:
            name: {{ .appname }}-volume-repository
            creationPolicy: Owner
            template:
              engineVersion: v2
              data:
                RESTIC_REPOSITORY: s3:http://minio-api-service/volume-backups/{{ .appname }}-volume
                RESTIC_PASSWORD: '{{ `{{ .RESTIC_PASSWORD }}` }}'
                AWS_ACCESS_KEY_ID: '{{ `{{ .AWS_ACCESS_KEY_ID }}` }}'
                AWS_SECRET_ACCESS_KEY: '{{ `{{ .AWS_SECRET_ACCESS_KEY }}` }}'
          data:
            - secretKey: RESTIC_PASSWORD
              remoteRef:
                key: RESTIC_PASSWORD
            - secretKey: AWS_ACCESS_KEY_ID
              remoteRef:
                key: MINIO_ACCESS_KEY
            - secretKey: AWS_SECRET_ACCESS_KEY
              remoteRef:
                key: MINIO_SECRET_KEY

        ---
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationSource
        metadata:
          name: volume-backup
        spec:
          sourcePVC: {{ .appname }}-volume
          trigger:
            schedule: '0 * * * *'
          restic:
            pruneIntervalDays: 14
            repository: volume-repository
            retain:
              hourly: 6
              daily: 5
              weekly: 4
              monthly: 2
              yearly: 1
            copyMethod: Direct

        ---
        # apiVersion: volsync.backube/v1alpha1
        # kind: ReplicationDestination
        # metadata:
        #   name: volume-restore
        # spec:
        #   trigger:
        #     manual: manual-once
        #   restic:
        #     repository: volume-repository
        #     destinationPVC: {{ .appname }}-volume
        #     copyMethod: Direct
        EOF

  pg:
    requires:
      vars: [appname]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > pg.yml
        ---
        apiVersion: postgresql.cnpg.io/v1
        kind: Cluster
        metadata:
          name: postgres
        spec:
          instances: 3
          storage:
            storageClass: local-storage
            size: 5Gi
          backup:
            retentionPolicy: 30d
            barmanObjectStore:
              destinationPath: s3://postgres-wal-backups
              endpointURL: http://minio-api-service
              s3Credentials:
                accessKeyId:
                  name: minio-secret
                  key: MINIO_ACCESS_KEY
                secretAccessKey:
                  name: minio-secret
                  key: MINIO_SECRET_KEY
          # bootstrap:
          #   recovery:
          #     source: {{ .appname }}-postgres
          # externalClusters:
          #   - name: {{ .appname }}-postgres
          #     barmanObjectStore:
          #       serverName: {{ .appname }}-postgres
          #       destinationPath: s3://postgres-wal-backups
          #       endpointURL: http://minio-api-service
          #       s3Credentials:
          #         accessKeyId:
          #           name: minio-secret
          #           key: MINIO_ACCESS_KEY
          #         secretAccessKey:
          #           name: minio-secret
          #           key: MINIO_SECRET_KEY
          #       wal:
          #         maxParallel: 8

        ---
        apiVersion: postgresql.cnpg.io/v1
        kind: ScheduledBackup
        metadata:
          name: backup
        spec:
          schedule: '0 0 0 * * *'
          backupOwnerReference: self
          cluster:
            name: {{ .appname }}-postgres
        EOF

  valkey:
    requires:
      vars: [appname]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > valkey.yml
        ---
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: valkey-deployment
          labels: &labels
            app.kubernetes.io/component: valkey
        spec:
          replicas: 1
          strategy:
            type: Recreate
          selector:
            matchLabels: *labels
          template:
            metadata:
              labels: *labels
            spec:
              containers:
                - name: valkey
                  image: docker.io/valkey/valkey:7.2
                  resources:
                    limits:
                      memory: 1G
                  ports:
                    - name: valkey
                      containerPort: 6379

        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: valkey-service
        spec:
          selector:
            app.kubernetes.io/component: valkey
          ports:
            - name: valkey
              port: 6379
              targetPort: valkey
        EOF

  secret:
    requires:
      vars: [appname]
    dir: ./services/{{ .appname }}/resources
    cmds:
      - |
        cat << EOF > secret.yml
        ---
        apiVersion: k8s.bitwarden.com/v1
        kind: BitwardenSecret
        metadata:
          name: secret
        spec:
          organizationId: 575f69b2-49f4-456d-bd6f-b14101103188
          secretName: {{ .appname }}-secret
          map:
            - secretKeyName: fakefakefake
              bwSecretId: fakefakefake
          authToken:
            secretName: bw-auth-token
            secretKey: token
        EOF
