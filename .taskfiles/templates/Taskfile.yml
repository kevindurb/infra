# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

# TODO: can i have global envs from vars?
# TODO: can i refactor out the minijinja command?

vars:
  TEMPLATES_DIR: '{{.ROOT_DIR}}/.taskfiles/templates/resources'
  MINIJINJA_ARGS: >-
    --env
    --trim-blocks
    --lstrip-blocks
    --autoescape=none

tasks:
  app:
    aliases: [mk]
    requires:
      vars: [APP, IMAGE]
    cmds:
      - task: kustomization
      - task: deployment
      - task: service
      - task: internal-ingress
      - task: gatus

  external-app:
    aliases: [mk-ext]
    requires:
      vars: [APP, IP]
    cmds:
      - task: kustomization
      - task: external-endpoint
      - task: gatus

  kustomization:
    aliases: [ks]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    env:
      APP: '{{.APP}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/kustomization.yml.j2
        > kustomization.yml

  deployment:
    aliases: [deploy]
    requires:
      vars: [APP, IMAGE, PORT]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: './resources/{{or .COMP "web"}}-deployment.yml'
    env:
      APP: '{{.APP}}'
      COMP: '{{or .COMP "web"}}'
      IMG: '{{.IMAGE}}'
      PORT: '{{.PORT}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/deployment.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  service:
    aliases: [svc]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: './resources/{{or .COMP "web"}}-service.yml'
    env:
      APP: '{{.APP}}'
      COMP: '{{or .COMP "web"}}'
      PORT: '{{.PORT}}'
      PROTO: '{{or .PROTO "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/service.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  external-endpoint:
    aliases: [ext]
    requires:
      vars: [APP, IP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: './resources/external-endpoint.yml'
    env:
      APP: '{{.APP}}'
      SUBDOMAIN: '{{or .subdomain .APP}}'
      IP: '{{.IP}}'
      PORT: '{{or .PORT "80"}}'
      PROTO: '{{or .PROTO "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/external-endpoint.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  internal-ingress:
    aliases: [int-ing]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: './resources/internal-ingress.yml'
    env:
      APP: '{{.APP}}'
      SUBDOMAIN: '{{or .subdomain .APP}}'
      PORT: '{{or .PORT "80"}}'
      PROTO: '{{or .PROTO "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/internal-ingress.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  external-ingress:
    aliases: [ext-ing]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: ./resources/external-ingress.yml
    env:
      APP: '{{.APP}}'
      SUBDOMAIN: '{{or .subdomain .APP}}'
      PORT: '{{or .PORT "80"}}'
      PROTO: '{{or .PROTO "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/external-ingress.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  persistent-volume-claim:
    aliases: [pvc]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: ./resources/pvc.yml
    env:
      APP: '{{.APP}}'
      SIZE: '{{or .size "1G"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/pvc.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  postgres:
    aliases: [pg, db]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: ./resources/postgres.yml
    env:
      APP: '{{.APP}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/postgres.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  valkey:
    aliases: [redis]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: ./resources/valkey.yml
    env:
      APP: '{{.APP}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/valkey.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  bitwarden-secret:
    aliases: [secret]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: ./resources/bitwarden-secret.yml
    env:
      APP: '{{.APP}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/bitwarden-secret.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}

  gatus-config:
    aliases: [gatus]
    requires:
      vars: [APP]
    dir: ./k8s/{{.APP}}
    vars:
      OUT_FILE: ./resources/gatus-config.yml
    env:
      APP: '{{.APP}}'
      PROTO: '{{or .PROTO "http"}}'
    cmds:
      - >
        minijinja-cli
        {{.MINIJINJA_ARGS}}
        {{.TEMPLATES_DIR}}/gatus-config.yml.j2
        > {{.OUT_FILE}}
      - kustomize edit add resource {{.OUT_FILE}}
