# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

vars:
  services:
    sh: ls ./services

tasks:
  force-update-external-secret:
    cmd: 'kubectl annotate externalsecret {{ .name }} force-sync=$(date +%s) --overwrite'
    requires:
      vars: [name]

  build-all:
    cmds:
      - rm -rf ./dist
      - mkdir ./dist
      - for:
          var: services
        cmd: kustomize build {{ joinPath "./services" .ITEM }} > ./dist/{{ .ITEM }}.yml
    sources:
      - services/**/*.yml
    generates:
      - dist/*.yml

  validate:
    vars:
      kubeconformArgs: >-
        -summary
        -output pretty
        -schema-location default
        -schema-location "https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{`{{ .NormalizedKubernetesVersion }}`}}/{{`{{ .ResourceKind }}`}}{{`{{ .KindSuffix }}`}}.json"
        -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{`{{.Group}}`}}/{{`{{.ResourceKind}}`}}_{{`{{.ResourceAPIVersion}}`}}.json'
    cmds:
      - task: build-all
      - kubeconform {{ .kubeconformArgs }} ./dist
