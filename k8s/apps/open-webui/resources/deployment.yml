---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    spec:
      volumes:
        - name: volume
          persistentVolumeClaim:
            claimName: volume
      containers:
        - name: open-webui
          image: ghcr.io/open-webui/open-webui:v0.5.2@sha256:aa12872705aa13552bd88760026f67913f438710c3af237d1a7d56a5ec7f9168
          resources:
            requests:
              memory: 500M
            limits:
              memory: 1G
          volumeMounts:
            - name: volume
              mountPath: /app/backend/data
          env:
            - name: DEFAULT_MODELS
              value: llama3.1:8b
            - name: ENABLE_OLLAMA_API
              value: 'true'
            - name: OLLAMA_BASE_URL
              value: http://ollama-service.apps
            - name: WEBUI_URL
              value: https://chat.durbin.casa
            - name: ENABLE_RAG_WEB_SEARCH
              value: 'true'
            - name: ENABLE_SEARCH_QUERY
              value: 'true'
            - name: RAG_WEB_SEARCH_ENGINE
              value: searxng
            - name: SEARXNG_QUERY_URL
              value: http://searxng-service.default/search?q=<query>
            - name: WEBUI_AUTH_TRUSTED_EMAIL_HEADER
              value: X-Auth-Request-Email
          ports:
            - name: web
              containerPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: service
spec:
  ports:
    - name: web
      port: 80
      targetPort: web

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: volume
#  labels:
#    snapscheduler/standard: 'true'
spec:
  accessModes: [ReadWriteOnce]
  storageClassName: zfs-iscsi
  resources:
    requests:
      storage: 5G
