# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: '3'

includes:
  templates: .taskfiles/kubernetes

tasks:
  setup:
    cmds:
      - ansible-galaxy install -r ./roles/requirements.yml
      - npm install

  provision-nodes: >-
    ansible-playbook
    -i ./inventory/production.yml
    ./playbooks/base_provision.yml

  lint: npx prettier -w .

  refresh-argo: hurl ./hurl/argo-webhook.hurl

  check-authelia-config: >-
    docker run
    -v ./services/authelia/resources/configuration.yml:/config/configuration.yml
    authelia/authelia:latest
    authelia config validate
    --config /config/configuration.yml

  generate-client-secret: >-
    docker run
    authelia/authelia:latest
    authelia crypto hash generate pbkdf2
    --variant sha512
    --random
    --random.length 72
    --random.charset rfc3986

  generate-random-token: openssl rand -hex 64

  add-cloudflare-route:
    cmds:
      - cloudflared tunnel route dns kube "{{.host}}"
    requires:
      vars: [host]
