# vim: set ft=yaml.ansible:
---
- hosts: all
  remote_user: kevindurb
  vars_files:
    - ../vars/main.yaml
  tasks:
    - name: install deps
      become: yes
      package:
        name:
          - apache2
          - apt-mirror
        state: present

    - name: start apache2
      become: yes
      systemd:
        name: apache2.service
        state: started
        enabled: yes

    - name: setup repo directory
      become: yes
      file:
        group: www-data
        owner: www-data
        path: /var/www/html/ubuntu
        state: directory

    - name: setup repo var directory
      become: yes
      file:
        group: www-data
        owner: www-data
        path: /var/www/html/ubuntu/var
        state: directory

    - name: point apt at www directory
      become: yes
      lineinfile:
        path: /etc/apt/mirror.list
        regexp: '^# set base_path'
        line: 'set base_path  /var/www/html/ubuntu'

    - name: setup post script
      become: yes
      copy:
        remote_src: yes
        src: /var/spool/apt-mirror/var/postmirror.sh
        dest: /var/www/html/ubuntu/var/postmirror.sh
